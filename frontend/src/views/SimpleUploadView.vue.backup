<template>
  <div class="simple-upload-view">
    <!-- STEP 1: Upload Screen -->
    <div v-if="currentStep === 'upload'" class="upload-step">
      <v-container>
        <v-row justify="center">
          <v-col cols="12" md="8" lg="6">
            <div class="text-center mb-8">
              <h1 class="text-h3 font-weight-bold mb-3" style="color: #731414">
                Análisis de Documentos Legales
              </h1>
              <p class="text-h6 text-grey-darken-1">
                Sube tu documento y obtén análisis automático
              </p>
            </div>

            <v-card elevation="8" class="upload-card">
              <v-card-text class="pa-8">
                <!-- Drop Zone -->
                <div
                  class="drop-zone"
                  :class="{
                    'drag-over': isDragOver,
                    'has-file': selectedFile !== null,
                  }"
                  @drop.prevent="handleDrop"
                  @dragover.prevent="isDragOver = true"
                  @dragleave.prevent="isDragOver = false"
                  @click="triggerFileInput"
                >
                  <v-icon
                    :size="selectedFile ? 80 : 120"
                    :color="selectedFile ? 'success' : 'primary'"
                    class="mb-4"
                  >
                    {{
                      selectedFile
                        ? "mdi-file-check-outline"
                        : "mdi-file-upload-outline"
                    }}
                  </v-icon>

                  <template v-if="!selectedFile">
                    <h3 class="text-h5 mb-2">Arrastra tu documento aquí</h3>
                    <p class="text-body-1 text-grey-darken-1 mb-4">
                      o haz clic para seleccionar
                    </p>
                    <v-chip color="primary" variant="outlined" size="large">
                      PDF, DOCX, DOC, TXT - Máx. 50MB
                    </v-chip>
                  </template>

                  <template v-else>
                    <h3 class="text-h5 mb-2 text-success">
                      {{ selectedFile.name }}
                    </h3>
                    <p class="text-body-1 text-grey-darken-1 mb-4">
                      {{ formatFileSize(selectedFile.size) }}
                    </p>
                    <v-btn
                      color="error"
                      variant="outlined"
                      @click.stop="clearFile"
                    >
                      <v-icon start>mdi-close</v-icon>
                      Cambiar archivo
                    </v-btn>
                  </template>
                </div>

                <input
                  ref="fileInput"
                  type="file"
                  accept=".pdf,.docx,.doc,.txt"
                  style="display: none"
                  @change="handleFileSelect"
                />

                <!-- Upload Button -->
                <v-btn
                  v-if="selectedFile"
                  color="primary"
                  size="x-large"
                  block
                  class="mt-6"
                  elevation="4"
                  :loading="isUploading"
                  @click="uploadDocument"
                >
                  <v-icon start>mdi-cloud-upload</v-icon>
                  Analizar Documento
                </v-btn>

                <!-- Error Message -->
                <v-alert
                  v-if="uploadError"
                  type="error"
                  variant="tonal"
                  class="mt-4"
                  closable
                  @click:close="uploadError = null"
                >
                  {{ uploadError }}
                </v-alert>
              </v-card-text>
            </v-card>
          </v-col>
        </v-row>
      </v-container>
    </div>

    <!-- STEP 2: Processing Screen -->
    <div v-if="currentStep === 'processing'" class="processing-step">
      <v-container>
        <v-row justify="center">
          <v-col cols="12" md="8" lg="6">
            <v-card elevation="8" class="processing-card">
              <v-card-text class="pa-8 text-center">
                <v-progress-circular
                  :model-value="processingProgress"
                  :size="150"
                  :width="15"
                  color="primary"
                  class="mb-6"
                >
                  <span class="text-h4 font-weight-bold">
                    {{ processingProgress }}%
                  </span>
                </v-progress-circular>

                <h2
                  class="text-h4 font-weight-bold mb-4"
                  style="color: #731414"
                >
                  Analizando Documento
                </h2>

                <p class="text-h6 text-grey-darken-1 mb-6">
                  {{ processingMessage }}
                </p>

                <!-- Processing Steps Indicator -->
                <v-stepper
                  v-model="processingStepIndex"
                  alt-labels
                  elevation="0"
                  class="mb-4"
                >
                  <v-stepper-header>
                    <v-stepper-item
                      v-for="(step, index) in processingSteps"
                      :key="index"
                      :value="index + 1"
                      :complete="processingStepIndex > index + 1"
                      :color="
                        processingStepIndex === index + 1
                          ? 'primary'
                          : 'success'
                      "
                    >
                      <template #icon>
                        <v-icon v-if="processingStepIndex > index + 1">
                          mdi-check
                        </v-icon>
                        <v-progress-circular
                          v-else-if="processingStepIndex === index + 1"
                          indeterminate
                          size="24"
                          width="3"
                        />
                        <span v-else>{{ index + 1 }}</span>
                      </template>
                      <template #title>
                        <div class="text-caption">{{ step.title }}</div>
                      </template>
                    </v-stepper-item>
                  </v-stepper-header>
                </v-stepper>

                <!-- Fun Facts While Waiting -->
                <v-card variant="tonal" color="primary" class="mt-6">
                  <v-card-text>
                    <div class="d-flex align-center">
                      <v-icon size="40" class="me-3"
                        >mdi-lightbulb-outline</v-icon
                      >
                      <div class="text-left">
                        <p class="text-subtitle-2 font-weight-bold mb-1">
                          ¿Sabías que...?
                        </p>
                        <p class="text-body-2">{{ currentFunFact }}</p>
                      </div>
                    </div>
                  </v-card-text>
                </v-card>

                <!-- Active Users Processing -->
                <div v-if="activeProcessingCount > 1" class="mt-4">
                  <v-chip color="info" variant="outlined">
                    <v-icon start>mdi-account-multiple</v-icon>
                    {{ activeProcessingCount }} documentos en proceso
                  </v-chip>
                </div>
              </v-card-text>
            </v-card>
          </v-col>
        </v-row>
      </v-container>
    </div>

    <!-- STEP 3: Results Screen -->
    <div v-if="currentStep === 'results'" class="results-step">
      <!-- Centered Container -->
      <v-container class="results-container">
        <!-- Header with Actions -->
        <div class="results-header mb-6">
          <div class="d-flex align-center justify-space-between">
            <div>
              <h2 class="text-h4 font-weight-bold mb-1" style="color: #731414">
                Análisis Completado
              </h2>
              <p class="text-body-2 text-grey-darken-1">
                {{ processedDocument?.title || "Documento analizado" }}
              </p>
            </div>
            <v-btn color="primary" variant="outlined" @click="resetToUpload">
              <v-icon start>mdi-plus</v-icon>
              Analizar Otro
            </v-btn>
          </div>
        </div>

        <!-- Main Content Grid (60/40 split) -->
        <v-row class="results-grid">
          <!-- Left Side: Document Viewer (60%) -->
          <v-col cols="12" lg="7" class="document-column">
            <v-card elevation="4" class="document-viewer-card">
              <v-card-title class="d-flex align-center bg-grey-lighten-3">
                <v-icon class="me-2" color="primary">mdi-file-document</v-icon>
                <span class="font-weight-bold">Documento Original</span>
                <v-spacer />
                <v-btn-group variant="outlined" density="compact">
                  <v-btn
                    v-if="processedDocument?.file_path"
                    size="small"
                    @click="openDocumentNewTab"
                  >
                    <v-icon size="small">mdi-open-in-new</v-icon>
                  </v-btn>
                  <v-btn
                    v-if="processedDocument?.file_path"
                    size="small"
                    @click="downloadDocument"
                  >
                    <v-icon size="small">mdi-download</v-icon>
                  </v-btn>
                </v-btn-group>
              </v-card-title>

              <v-card-text class="pa-0">
                <div class="document-preview">
                  <!-- Try iframe first, show error message if blocked -->
                  <div
                    v-if="documentUrl && !iframeError"
                    class="iframe-container"
                  >
                    <iframe
                      :src="documentUrl"
                      class="document-iframe"
                      frameborder="0"
                      @error="handleIframeError"
                    />
                  </div>

                  <!-- Fallback: Download button if iframe blocked -->
                  <div v-else-if="iframeError" class="preview-placeholder">
                    <v-icon size="100" color="primary">
                      mdi-file-pdf-box
                    </v-icon>
                    <p class="text-h6 text-grey-darken-2 mt-4">
                      Vista previa no disponible
                    </p>
                    <p class="text-body-2 text-grey mt-2 mb-4">
                      El navegador bloqueó la vista previa del PDF
                    </p>
                    <v-btn
                      color="primary"
                      size="large"
                      @click="downloadDocument"
                    >
                      <v-icon start>mdi-download</v-icon>
                      Descargar Documento
                    </v-btn>
                    <v-btn
                      color="primary"
                      variant="outlined"
                      size="large"
                      class="mt-3"
                      @click="openDocumentNewTab"
                    >
                      <v-icon start>mdi-open-in-new</v-icon>
                      Abrir en Nueva Pestaña
                    </v-btn>
                  </div>

                  <!-- No document available -->
                  <div v-else class="preview-placeholder">
                    <v-icon size="100" color="grey-lighten-1">
                      mdi-file-document-outline
                    </v-icon>
                    <p class="text-h6 text-grey mt-4">
                      Vista previa no disponible
                    </p>
                  </div>
                </div>
              </v-card-text>
            </v-card>
          </v-col>

          <!-- Right Side: Chat Analysis Panel (40%) -->
          <v-col cols="12" lg="5" class="analysis-column">
            <ChatAnalysisPanel
              v-if="processedDocument"
              :document="processedDocument"
              :similar-documents="similarDocuments"
              :loading-similar="loadingSimilar"
              :show-metadata="true"
              @select-similar="viewSimilarDocument"
            />
          </v-col>
        </v-row>
      </v-container>
    </div>
  </div>
</template>

<script setup>
import { ref, computed, onMounted, onUnmounted } from "vue";
import axios from "axios";
import ChatAnalysisPanel from "../components/ChatAnalysisPanel.vue";
                    <v-card
                      v-for="(doc, idx) in similarDocuments.slice(0, 3)"
                      :key="doc.document_id || idx"
                      class="similar-doc-card mb-3"
                      variant="outlined"
                      @click="viewSimilarDocument(doc)"
                      style="cursor: pointer"
                    >
                      <v-tooltip activator="parent" location="top">
                        Clic para ver documento
                      </v-tooltip>
                      <v-card-text class="pa-3">
                        <div
                          class="d-flex justify-space-between align-start mb-3 flex-wrap gap-2"
                        >
                          <div class="d-flex gap-1 flex-wrap">
                            <v-chip
                              v-if="doc.hybrid_score || doc.similarity"
                              :color="
                                getSimilarityColor(
                                  doc.hybrid_score ?? doc.similarity
                                )
                              "
                              size="small"
                              variant="flat"
                              class="similarity-chip font-weight-bold text-white"
                            >
                              <v-icon start size="small">mdi-chart-line</v-icon>
                              {{
                                (
                                  (doc.hybrid_score ?? doc.similarity) * 100
                                ).toFixed(1)
                              }}% Score
                            </v-chip>
                            <v-chip
                              v-if="doc.semantic_score || doc.similarity_score"
                              color="#736D5D"
                              size="small"
                              variant="outlined"
                              class="font-weight-medium"
                            >
                              <v-icon start size="x-small">mdi-brain</v-icon>
                              Sem:
                              {{
                                (
                                  (doc.semantic_score || doc.similarity_score) *
                                  100
                                ).toFixed(1)
                              }}%
                            </v-chip>
                            <v-chip
                              v-if="doc.bm25_score"
                              color="#736D5D"
                              size="small"
                              variant="outlined"
                              class="font-weight-medium"
                            >
                              <v-icon start size="x-small"
                                >mdi-text-search</v-icon
                              >
                              BM25: {{ doc.bm25_score.toFixed(2) }}
                            </v-chip>
                            <v-chip
                              v-if="
                                doc.metadata_boost && doc.metadata_boost > 0
                              "
                              color="green-darken-1"
                              size="small"
                              variant="tonal"
                              class="font-weight-medium"
                            >
                              <v-icon start size="x-small"
                                >mdi-arrow-up-circle</v-icon
                              >
                              +{{ (doc.metadata_boost * 100).toFixed(1) }}%
                            </v-chip>
                            <v-chip
                              v-if="doc.penalties && doc.penalties < 0"
                              color="orange-darken-2"
                              size="small"
                              variant="tonal"
                              class="font-weight-medium"
                            >
                              <v-icon start size="x-small"
                                >mdi-arrow-down-circle</v-icon
                              >
                              {{ (doc.penalties * 100).toFixed(1) }}%
                            </v-chip>
                          </div>
                          <v-icon size="small" color="#8c0d0d"
                            >mdi-arrow-expand-right</v-icon
                          >
                        </div>
                        <div
                          class="similar-title text-subtitle-2 font-weight-medium mb-2"
                        >
                          {{ doc.title || "Documento sin título" }}
                        </div>
                        <div class="d-flex gap-2 flex-wrap">
                          <v-chip
                            v-if="doc.doc_type?.name || doc.doc_type"
                            size="x-small"
                            variant="flat"
                            style="background-color: #736d5d"
                            class="text-white"
                          >
                            <v-icon start size="x-small"
                              >mdi-file-document-outline</v-icon
                            >
                            {{
                              doc.doc_type?.name || formatDocType(doc.doc_type)
                            }}
                          </v-chip>
                          <v-chip
                            v-if="doc.legal_area?.name || doc.legal_area"
                            size="x-small"
                            variant="flat"
                            style="background-color: #8c0d0d"
                            class="text-white"
                          >
                            <v-icon start size="x-small"
                              >mdi-scale-balance</v-icon
                            >
                            {{
                              doc.legal_area?.name ||
                              formatLegalArea(doc.legal_area)
                            }}
                          </v-chip>
                          <v-chip
                            v-if="doc.document_date"
                            size="x-small"
                            variant="outlined"
                            color="#736D5D"
                          >
                            <v-icon start size="x-small"
                              >mdi-calendar-outline</v-icon
                            >
                            {{ doc.document_date }}
                          </v-chip>
                        </div>
                      </v-card-text>
                    </v-card>
                  </div>
                </v-card-text>
              </v-card>
            </div>
          </v-col>
        </v-row>
      </v-container>
    </div>
  </div>
</template>

<script setup>
import { ref, computed, onMounted, onUnmounted } from "vue";
import axios from "axios";

/* ========== STATE ========== */
const currentStep = ref("upload"); // 'upload', 'processing', 'results'
const selectedFile = ref(null);
const isDragOver = ref(false);
const isUploading = ref(false);
const uploadError = ref(null);
const fileInput = ref(null);

// Processing state
const processingProgress = ref(0);
const processingMessage = ref("Iniciando análisis...");
const processingStepIndex = ref(1);
const documentId = ref(null);
const taskId = ref(null);
const pollingInterval = ref(null);
const activeProcessingCount = ref(1);

// Results state
const processedDocument = ref(null);
const similarDocuments = ref([]);
const loadingSimilar = ref(false);
const documentUrl = ref(null);
const iframeError = ref(false);

// Processing steps for visual feedback
const processingSteps = [
  { title: "Analizando metadatos", value: 0 },
  { title: "Generando título", value: 25 },
  { title: "Generando resumen", value: 50 },
  { title: "Extrayendo personas", value: 75 },
  { title: "Finalizando", value: 95 },
];

// Fun facts to show while processing
const funFacts = [
  "El sistema utiliza inteligencia artificial para comprender el contexto legal de los documentos.",
  "Nuestro análisis puede identificar partes involucradas, fechas clave y decisiones judiciales.",
  "La búsqueda de documentos similares utiliza algoritmos de similitud semántica avanzados.",
  "El resumen se genera automáticamente manteniendo la información legal más relevante.",
  "Los embeddings vectoriales nos permiten encontrar documentos con contenido similar aunque usen palabras diferentes.",
];

const currentFunFact = ref(funFacts[0]);
let funFactInterval = null;

/* ========== COMPUTED ========== */

/* ========== FILE HANDLING ========== */
function triggerFileInput() {
  fileInput.value?.click();
}

function handleFileSelect(event) {
  const file = event.target.files[0];
  if (file) {
    validateAndSetFile(file);
  }
}

function handleDrop(event) {
  isDragOver.value = false;
  const file = event.dataTransfer.files[0];
  if (file) {
    validateAndSetFile(file);
  }
}

function validateAndSetFile(file) {
  // Validate file type
  const allowedTypes = [
    "application/pdf",
    "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
    "application/msword",
    "text/plain",
  ];

  if (!allowedTypes.includes(file.type)) {
    uploadError.value =
      "Tipo de archivo no soportado. Por favor sube PDF, DOCX, DOC o TXT.";
    return;
  }

  // Validate file size (50MB max)
  const maxSize = 50 * 1024 * 1024;
  if (file.size > maxSize) {
    uploadError.value = "El archivo es demasiado grande. Máximo 50MB.";
    return;
  }

  selectedFile.value = file;
  uploadError.value = null;
}

function clearFile() {
  selectedFile.value = null;
  if (fileInput.value) {
    fileInput.value.value = "";
  }
}

function formatFileSize(bytes) {
  if (bytes === 0) return "0 Bytes";
  const k = 1024;
  const sizes = ["Bytes", "KB", "MB", "GB"];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + " " + sizes[i];
}

/* ========== UPLOAD & PROCESSING ========== */
async function uploadDocument() {
  if (!selectedFile.value) return;

  isUploading.value = true;
  uploadError.value = null;

  try {
    const formData = new FormData();
    formData.append("file", selectedFile.value);

    // Set analysis options (simplified - always analyze everything)
    formData.append("analyze_metadata", "true");
    formData.append("analyze_title", "false");
    formData.append("analyze_summary", "true");
    formData.append("analyze_persons", "false");
    formData.append("summarizer_type", "ollama"); // or 'bart'

    const response = await axios.post("/api/documents/", formData, {
      headers: {
        "Content-Type": "multipart/form-data",
      },
    });

    // Backend returns: { document: {...}, upload_task: {...}, analysis_task: {...} }
    documentId.value = response.data.document.document_id;

    // If there's an analysis task, track that instead of upload task
    // because analysis includes summary and similar docs generation
    if (response.data.analysis_task) {
      taskId.value = response.data.analysis_task.task_id;
    } else {
      taskId.value = response.data.upload_task.task_id;
    }

    // Debug logging
    console.log("Upload successful:", {
      document_id: documentId.value,
      task_id: taskId.value,
      has_analysis: !!response.data.analysis_task,
      upload_task: response.data.upload_task,
      analysis_task: response.data.analysis_task,
      form_data: {
        analyze_metadata: "true",
        analyze_title: "true",
        analyze_summary: "true",
        analyze_persons: "true",
        summarizer_type: "ollama",
      },
    });

    // Switch to processing screen
    currentStep.value = "processing";
    startProcessingMonitoring();
    startFunFactRotation();
  } catch (error) {
    console.error("Upload error:", error);
    uploadError.value =
      error.response?.data?.error ||
      error.response?.data?.message ||
      "Error al subir el documento. Por favor intenta de nuevo.";
  } finally {
    isUploading.value = false;
  }
}

function startProcessingMonitoring() {
  // Poll task status every 2 seconds
  pollingInterval.value = setInterval(async () => {
    await checkTaskStatus();
  }, 2000);

  // Also check immediately
  checkTaskStatus();
}

async function checkTaskStatus() {
  if (!taskId.value) return;

  try {
    const response = await axios.get(`/api/tasks/${taskId.value}/`);
    const task = response.data;

    // Debug logging
    console.log("Task status update:", {
      task_id: taskId.value,
      status: task.status,
      progress: task.progress_percent,
      message: task.progress_message,
    });

    // Update progress
    processingProgress.value = task.progress_percent || 0;
    processingMessage.value = task.progress_message || "Procesando...";

    // Update step indicator based on progress
    // Backend progress: metadata=10%, title=30%, summary=50%, persons=70%, finalize=95%
    if (processingProgress.value < 20) {
      processingStepIndex.value = 1; // Metadata (0-19%)
    } else if (processingProgress.value < 40) {
      processingStepIndex.value = 2; // Title (20-39%)
    } else if (processingProgress.value < 60) {
      processingStepIndex.value = 3; // Summary (40-59%)
    } else if (processingProgress.value < 80) {
      processingStepIndex.value = 4; // Persons (60-79%)
    } else {
      processingStepIndex.value = 5; // Finalize (80-100%)
    }

    // Check if completed
    if (task.status === "success") {
      stopProcessingMonitoring();
      await loadDocumentResults();
      await loadSimilarDocuments();
      currentStep.value = "results";
    } else if (task.status === "failure") {
      stopProcessingMonitoring();
      uploadError.value =
        task.error_message || "Error al procesar el documento";
      currentStep.value = "upload";
    }

    // Get active processing count
    const statsResponse = await axios.get("/api/tasks/stats/");
    activeProcessingCount.value =
      (statsResponse.data.by_status?.started || 0) +
      (statsResponse.data.by_status?.progress || 0);
  } catch (error) {
    console.error("Error checking task status:", error);
    console.error("Error details:", {
      message: error.message,
      response: error.response?.data,
      status: error.response?.status,
    });

    // If task not found or other error, stop polling after several attempts
    if (error.response?.status === 404) {
      console.warn("Task not found, stopping polling");
      stopProcessingMonitoring();
      uploadError.value =
        "No se pudo encontrar la tarea. Por favor intenta de nuevo.";
      currentStep.value = "upload";
    }
  }
}

function stopProcessingMonitoring() {
  if (pollingInterval.value) {
    clearInterval(pollingInterval.value);
    pollingInterval.value = null;
  }
  if (funFactInterval) {
    clearInterval(funFactInterval);
    funFactInterval = null;
  }
}

function startFunFactRotation() {
  let currentIndex = 0;
  funFactInterval = setInterval(() => {
    currentIndex = (currentIndex + 1) % funFacts.length;
    currentFunFact.value = funFacts[currentIndex];
  }, 8000); // Change every 8 seconds
}

async function loadDocumentResults() {
  try {
    // Load document details
    let docResponse = await axios.get(`/api/documents/${documentId.value}/`);
    processedDocument.value = docResponse.data;

    console.log("Document loaded (initial):", {
      id: processedDocument.value.document_id,
      has_summary: !!processedDocument.value.summary,
      has_summary_embedding: processedDocument.value.has_summary_embedding,
      has_enhanced_embedding: processedDocument.value.has_enhanced_embedding,
    });

    // Setup document URL for preview
    if (processedDocument.value.file_path) {
      documentUrl.value = processedDocument.value.file_path;
    }

    // If summary exists but embeddings don't, wait and retry (they're being generated)
    if (
      processedDocument.value.summary &&
      !processedDocument.value.has_summary_embedding &&
      !processedDocument.value.has_enhanced_embedding
    ) {
      console.log(
        "Summary exists but embeddings not ready yet. Waiting 2 seconds..."
      );
      await new Promise((resolve) => setTimeout(resolve, 2000));

      // Reload document to get fresh embeddings
      docResponse = await axios.get(`/api/documents/${documentId.value}/`);
      processedDocument.value = docResponse.data;

      console.log("Document reloaded after wait:", {
        has_summary_embedding: processedDocument.value.has_summary_embedding,
        has_enhanced_embedding: processedDocument.value.has_enhanced_embedding,
      });
    }

    // Switch to results screen
    currentStep.value = "results";

    // Load similar documents after switching to results
    await loadSimilarDocuments();
  } catch (error) {
    console.error("Error loading document results:", error);
    uploadError.value = "Error al cargar los resultados del análisis";
    currentStep.value = "upload";
  }
}

// Load similar documents function (extracted for clarity)
async function loadSimilarDocuments() {
  loadingSimilar.value = true;

  try {
    if (
      processedDocument.value.has_summary_embedding ||
      processedDocument.value.has_enhanced_embedding
    ) {
      console.log("Loading similar documents with embeddings...");

      const similarResponse = await axios.get(
        `/api/documents/${documentId.value}/similar/?top_n=10&min_similarity=0.5&use_hybrid=true`
      );

      console.log("Similar documents API response:", {
        total_similar: similarResponse.data.total_similar,
        count: similarResponse.data.similar_documents?.length || 0,
      });

      similarDocuments.value = similarResponse.data.similar_documents || [];

      console.log(
        `✅ Found ${similarDocuments.value.length} similar documents`
      );
    } else {
      console.warn("⚠️ No embeddings available, skipping similarity search");
      similarDocuments.value = [];
    }
  } catch (error) {
    console.error("❌ Error loading similar documents:", error);
    console.error("Error details:", error.response?.data);
    similarDocuments.value = [];
  } finally {
    loadingSimilar.value = false;
  }
}

/* ========== RESULTS ACTIONS ========== */
function resetToUpload() {
  currentStep.value = "upload";
  selectedFile.value = null;
  processedDocument.value = null;
  similarDocuments.value = [];
  documentId.value = null;
  taskId.value = null;
  processingProgress.value = 0;
  processingStepIndex.value = 1;
  uploadError.value = null;
  iframeError.value = false;
}

function handleIframeError() {
  console.warn("Iframe loading failed, showing fallback");
  iframeError.value = true;
}

function openDocumentNewTab() {
  if (processedDocument.value?.file_path) {
    window.open(processedDocument.value.file_path, "_blank");
  }
}

function downloadDocument() {
  if (processedDocument.value?.file_path) {
    const link = document.createElement("a");
    link.href = processedDocument.value.file_path;
    link.download = processedDocument.value.title || "documento.pdf";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }
}

function viewSimilarDocument(doc) {
  // Open in new tab or navigate to document detail
  // For now, we'll just open the document
  if (doc.file_path) {
    window.open(doc.file_path, "_blank");
  }
}

function getSimilarityColor(similarity) {
  if (similarity >= 0.8) return "success";
  if (similarity >= 0.6) return "info";
  if (similarity >= 0.4) return "warning";
  return "error";
}

function formatDocType(type) {
  const types = {
    sentencia: "Sentencia",
    auto: "Auto",
    resolucion: "Resolución",
    decreto: "Decreto",
    providencia: "Providencia",
    otros: "Otros",
  };
  return types[type] || type;
}

function formatLegalArea(area) {
  const areas = {
    civil: "Civil",
    penal: "Penal",
    laboral: "Laboral",
    comercial: "Comercial",
    administrativo: "Administrativo",
    constitucional: "Constitucional",
    familia: "Familia",
    otros: "Otros",
  };
  return areas[area] || area;
}

/* ========== LIFECYCLE ========== */
onMounted(() => {
  // Any initialization
});

onUnmounted(() => {
  stopProcessingMonitoring();
});
</script>

<style scoped>
.simple-upload-view {
  min-height: 100vh;
  background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
  padding: 2rem 0;
}

/* Upload Step */
.upload-step {
  padding-top: 4rem;
}

.upload-card {
  border-radius: 16px;
  background: white;
}

.drop-zone {
  border: 3px dashed #ccc;
  border-radius: 12px;
  padding: 4rem 2rem;
  cursor: pointer;
  transition: all 0.3s ease;
  background: #fafafa;
}

.drop-zone:hover {
  border-color: #731414;
  background: #f5f5f5;
}

.drop-zone.drag-over {
  border-color: #731414;
  background: #fff8f8;
  transform: scale(1.02);
}

.drop-zone.has-file {
  border-color: #4caf50;
  background: #f1f8f4;
}

/* Processing Step */
.processing-step {
  padding-top: 4rem;
}

.processing-card {
  border-radius: 16px;
  background: white;
}

/* Results Step */
.results-step {
  padding-top: 2rem;
}

.document-viewer-card {
  border-radius: 12px;
  height: calc(100vh - 200px);
  display: flex;
  flex-direction: column;
}

.document-preview {
  height: calc(100vh - 260px);
  background: #f5f5f5;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
}

.iframe-container {
  width: 100%;
  height: 100%;
  position: relative;
}

.document-iframe {
  width: 100%;
  height: 100%;
  border: none;
}

.preview-placeholder {
  text-align: center;
  padding: 2rem;
}

.results-panels {
  max-height: calc(100vh - 200px);
  overflow-y: auto;
}

.summary-content {
  max-height: 400px;
  overflow-y: auto;
}

.metadata-grid {
  display: grid;
  gap: 0.75rem;
}

.metadata-item {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.similar-docs-list {
  max-height: 500px;
  overflow-y: auto;
}

.similar-doc-item {
  border-bottom: 1px solid #e0e0e0;
  transition: background-color 0.2s;
}

.similar-doc-item:hover {
  background-color: #f5f5f5;
}

.similar-doc-item:last-child {
  border-bottom: none;
}

/* Responsive */
@media (max-width: 960px) {
  .document-viewer-card {
    height: 400px;
    margin-bottom: 1rem;
  }

  .document-preview {
    height: 340px;
  }

  .results-panels {
    max-height: none;
  }
}
</style>
